<script>
  const metricName = "Mode share";
  const unit = "%";
  const unitsLabel = `${metricName} (${unit})`;

  const dataUrl    = "combined_points_long_expanded.csv"; 
  const lonField   = "lon";
  const latField   = "lat";
  const valueField = "value";
  const metricField= "metric";

  const spec = {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: 960, height: 560,
    background: "#ffffff",
    title: { text: "Melbourne CBD â€” Proportional Symbols + Heatmap", subtitle: unitsLabel, anchor: "start" },

    // a UI control to pick the mode
    params: [{
      name: "modeSel",
      value: "Public transport",
      bind: { input: "select", options: ["Public transport","Car","Active"], name: "Mode: " }
    }],

    projection: { type: "mercator", center: [144.9631, -37.8136], scale: 31000 },

    layer: [
      { data: { sphere: true }, mark: { type: "geoshape", fill: "#eaf4ff" }},
      { data: {
          url: "ne_110m_admin_0_countries.topojson",
          format: { type: "topojson", feature: "ne_110m_admin_0_countries" }
        },
        mark: { type: "geoshape", fill: "#cfe3ff", stroke: "#9dc4f4", strokeWidth: 0.8 } },
      { data: { graticule: { step: [0.2, 0.2] } },
        mark: { type: "geoshape", fill: null, stroke: "#c8d0d8", strokeWidth: 0.6 } },

      // HEATMAP for the selected mode
      {
        data: { url: dataUrl, format: { type: "csv" } },
        transform: [
          { filter: `datum['${metricField}'] == modeSel` },
          { calculate: `toNumber(datum['${lonField}'])`, as: "lonN" },
          { calculate: `toNumber(datum['${latField}'])`, as: "latN" },
          { calculate: `toNumber(datum['${valueField}'])`, as: "valN" },
          { filter: "isFinite(datum.lonN) && isFinite(datum.latN) && isFinite(datum.valN)" },
          { filter: "datum.lonN >= 144.5 && datum.lonN <= 145.5 && datum.latN >= -38.3 && datum.latN <= -37.5" },
          { bin: { maxbins: 60 }, field: "lonN", as: ["lonBin", "lonBin_end"] },
          { bin: { maxbins: 60 }, field: "latN", as: ["latBin", "latBin_end"] },
          { aggregate: [{ op: "sum", field: "valN", as: "heat" }],
            groupby: ["lonBin","lonBin_end","latBin","latBin_end"] },
          { filter: "isFinite(datum.heat)" }
        ],
        mark: { type: "rect", opacity: 0.5 },
        encoding: {
          x:  { field: "lonBin", type: "quantitative", axis: null },
          x2: { field: "lonBin_end" },
          y:  { field: "latBin", type: "quantitative", axis: null },
          y2: { field: "latBin_end" },
          color: {
            field: "heat", type: "quantitative",
            scale: { scheme: "oranges", nice: true, domainMin: 0 },
            legend: {
              title: `Heat (sum of ${unitsLabel})`,
              orient: "right",
              gradientLength: 140,
              labelExpr: `format(datum.value, '~s') + ' ${unit}'`
            }
          },
          tooltip: [{ field: "heat", title: `Sum ${unitsLabel}`, format: ".1f" }]
        }
      },

      // POINTS for the selected mode
      {
        data: { url: dataUrl, format: { type: "csv" } },
        transform: [
          { filter: `datum['${metricField}'] == modeSel` },
          { calculate: `toNumber(datum['${lonField}'])`, as: "lonN" },
          { calculate: `toNumber(datum['${latField}'])`, as: "latN" },
          { calculate: `toNumber(datum['${valueField}'])`, as: "valN" },
          { calculate: "datum.name ? datum.name : 'Location'", as: "label" },
          { filter: "isFinite(datum.lonN) && isFinite(datum.latN) && isFinite(datum.valN)" },
          { filter: "datum.lonN >= 144.5 && datum.lonN <= 145.5 && datum.latN >= -38.3 && datum.latN <= -37.5" }
        ],
        mark: { type: "circle", opacity: 0.9, fill: "#ffffff", stroke: "#2f6fab", strokeWidth: 1.2 },
        encoding: {
          longitude: { field: "lonN", type: "quantitative" },
          latitude:  { field: "latN", type: "quantitative" },
          size: {
            field: "valN", type: "quantitative",
            scale: { type: "sqrt", range: [20, 260] },
            legend: {
              title: unitsLabel,
              orient: "right",
              symbolType: "circle",
              symbolFillColor: "#ffffff",
              symbolStrokeColor: "#2f6fab",
              symbolStrokeWidth: 1.2,
              labelExpr: `format(datum.value, '~s') + ' ${unit}'`
            }
          },
          order: { field: "valN", sort: "descending" },
          tooltip: [
            { field: "label", title: "Place" },
            { field: "valN", title: unitsLabel, format: ".1f" },
            { field: "latN", title: "Lat", format: ".4f" },
            { field: "lonN", title: "Lon", format: ".4f" }
          ]
        }
      }
    ],

    resolve: { scale: { color: "independent" } },
    config: {
      view: { stroke: null, clip: true },
      legend: { titleFontSize: 12, labelFontSize: 11, orient: "right", labelLimit: 160 },
      axis: { grid: false }
    }
  };

  vegaEmbed("#vis", spec, { actions: false });
</script>
